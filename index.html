<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RandoTron</title>
  <!-- Google Fonts: Inter + Orbitron (cyberpunk display) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #181a20;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: #f3f4f6;
    }
    .container {
      max-width: 4020px;
      margin: 48px auto;
      background: #23262f;
  position: relative;
      border-radius: 18px;
      box-shadow: 0 4px 32px rgba(0,0,0,0.18);
      padding: 36px 28px;
      display: flex;
      flex-direction: column;
      gap: 28px;
      border: 1.5px solid #282c34;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    h1 {
      font-family: 'Orbitron', 'Inter', Arial, sans-serif;
      font-size: 2.8rem;
      text-align: center;
      margin-bottom: 18px;
      color: #9b7bff;
      font-weight: 700;
      letter-spacing: 0.02em;
      line-height: 1;
      /* neon / cyberpunk gradient + glow */
  background: linear-gradient(90deg, #9b7bff 0%, #6c47ff 45%, #00e0ff 100%);
  background-clip: text;
  -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow:
        0 2px 8px rgba(108,71,255,0.12),
        0 0 14px rgba(108,71,255,0.22),
        0 0 28px rgba(0,224,255,0.12);
      -webkit-text-stroke: 0.5px rgba(10,10,12,0.12);
    }
    label {
      font-size: 1.12rem;
      margin-bottom: 7px;
      color: #ffffff;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid #353945;
      border-radius: 8px;
      font-size: 1.05rem;
      background: #23262f;
    color: rgba(243,244,246,0.4) !important;
    -webkit-text-fill-color: rgba(243,244,246,0.4) !important;
      transition: border 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
      outline: none;
      margin-top: 2px;
    }
    input[type="text"]:focus, textarea:focus {
      border: 1.5px solid #6c47ff;
      box-shadow: 0 0 0 2px #6c47ff33;
    }
    
    input::placeholder, textarea::placeholder {
      color: #bfc7d5;
      font-family: inherit;
      font-size: 1.05rem;
      font-weight: 400;
      opacity: 1;
    }
    textarea {
      min-height: 70px;
      max-height: 220px;
      resize: vertical;
    }
    form > div {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .form-group {
      margin-bottom: 32px;
    }
    .form-group:last-child {
      margin-bottom: 0;
    }
    .toggle-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0;
      margin-bottom: 18px;
      background: #23262f;
      border-radius: 8px;
      overflow: hidden;
      border: 1.5px solid #353945;
      /* make the toggle row span the available width */
      width: 100%;
      max-width: 100%;
      margin-left: 0;
      margin-right: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      height: 65px;
      box-sizing: border-box;
      padding: 0;
    }
    .toggle-btn {
      padding: 10px 16px;
      font-size: 1.05rem;
      font-weight: 600;
      color: #bfc7d5;
      background: none;
      border: none;
      cursor: pointer;
      transition: background 0.18s, color 0.18s;
      outline: none;
      user-select: none;
      border-right: 1.5px solid #353945;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      white-space: normal;
  max-width: 220px;
  min-width: 0; /* allow shrinking on small screens */
  flex: 1 1 auto; /* distribute available width evenly */
      height: 100%;
      line-height: 1.15;
      padding-top: 8px;
      padding-bottom: 8px;
    }
    .toggle-btn:last-child {
      border-right: none;
    }
    .toggle-btn.active {
      background: #6c47ff;
      color: #fff;
      /* box-shadow: 0 2px 8px #6c47ff33; */
      z-index: 1;
    }
    .send-btn {
      display: block;
      margin: 28px auto 0 auto;
      padding: 18px 44px;
      background: #6c47ff;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.18rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 8px #6c47ff33;
      letter-spacing: 0.01em;
      transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
      text-align: center;
      width: 100%;
    }
    .send-btn:hover, .send-btn:focus {
      background: #7e5fff;
      box-shadow: 0 4px 16px #6c47ff44;
      transform: translateY(-2px) scale(1.03);
    }

    .scheduled-btn {
  background: #06b6d4 !important; /* cyan */
  color: #ffffff !important;
  box-shadow: 0 6px 18px rgba(6,182,212,0.18) !important;
      transform: translateY(-1px) scale(1.01);
    }

    .add-multi-btn {
      display: block;
      width: 100%;
      padding: 12px 14px;
      margin-top: 10px;
      border-radius: 10px;
      border: 1.5px solid #6c47ff;
      background: linear-gradient(180deg, rgba(108,71,255,0.04), rgba(108,71,255,0.02));
      color: #ffffff;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 2px 8px #6c47ff22;
      transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
    }
    .add-multi-btn:hover, .add-multi-btn:focus {
      background: #6c47ff11;
      box-shadow: 0 6px 18px #6c47ff33;
      transform: translateY(-2px);
    }
    
    .theme-toggle {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 6px 10px;
      height: 36px;
      min-width: 56px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: #ffffff;
      color: #0b0b0d;
      font-weight: 600;
      font-size: 0.95rem;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.12s, color 0.12s, transform 0.08s;
      box-shadow: 0 2px 6px rgba(15,15,15,0.08);
      z-index: 12;
    }
    .theme-toggle:hover { transform: translateY(-1px); }

    .light-theme {
      background: #f6f7fb;
      color: #0b0b0d;
    }
    .light-theme .theme-toggle {
      background: #0b0b0d;
      color: #fff;
      border-color: transparent;
      box-shadow: 0 2px 8px rgba(2,6,23,0.16);
    }
    .light-theme .container {
      background: #ffffff;
      border-color: #e6e9ef;
      box-shadow: 0 6px 24px rgba(15,15,15,0.06);
    }
  .light-theme h1 {
    /* keep gradient/clip effect in light mode as well */
    color: inherit;
    background: linear-gradient(90deg, #8a63ff 0%, #6c47ff 50%, #0ef0ff 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .light-theme label { color: #1f2937; }
    .light-theme input[type="text"], .light-theme textarea {
      background: #ffffff;
      border-color: #e6e9ef;
      color: rgba(15,15,20,0.85) !important;
      -webkit-text-fill-color: rgba(15,15,20,0.85) !important;
    }
    .light-theme .toggle-btn { color: #374151; }
  .light-theme .toggle-btn.active { background: #4f46e5; color: #fff; }
  
  .light-theme .add-multi-btn { color: #0b0b0d; border-color: #4f46e5; box-shadow: 0 4px 14px #4f46e533; }
  .light-theme .toggle-group { background: #f7f8fb; border-color: #e6e9ef; }
  .light-theme .toggle-btn { border-color: #e6e9ef; }
    @media (max-width: 500px) {
      .container {
        margin: 12px;
        padding: 18px 4px;
      }
      h1 {
        font-size: 1.95rem;
      }
      .theme-toggle {
        top: 8px;
        right: 8px;
        padding: 6px 8px;
        font-size: 0.85rem;
        height: 34px;
        min-width: 48px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
  <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">Light</button>
  <h1>RandoTron</h1>
    <div class="toggle-group">
      <input type="radio" name="mode" id="modeText" value="text" checked hidden>
      <label for="modeText" class="toggle-btn" id="labelText">Text</label>
      <input type="radio" name="mode" id="modeImage" value="image" hidden>
      <label for="modeImage" class="toggle-btn" id="labelImage">Image Caption</label>
  <input type="radio" name="mode" id="modeDelay" value="delay" hidden>
  <label for="modeDelay" class="toggle-btn" id="labelDelay">Delay</label>
      <input type="radio" name="mode" id="modeMulti" value="multi" hidden>
      <label for="modeMulti" class="toggle-btn" id="labelMulti">Multi Links</label>
    </div>
    <form id="randotronForm">
      <div class="form-group">
        <label for="passcode">Passcode</label>
        <input type="text" id="passcode" name="passcode" placeholder="Enter passcode">
      </div>
      <div id="textFields">
        <div class="form-group">
          <label for="message">Message/Link</label>
          <input type="text" id="message" name="message" placeholder="Enter message or link">
        </div>
      </div>
      <div id="imageFields" style="display: none;">
        <div class="form-group">
          <label for="caption">Caption</label>
          <input type="text" id="caption" name="caption" placeholder="Enter caption">
        </div>
        <div class="form-group">
          <label for="imageLink">Image Link</label>
          <input type="text" id="imageLink" name="imageLink" placeholder="Enter image URL">
        </div>
      </div>
      <div id="delayFields" style="display: none;">
        <div class="form-group">
          <label for="delayCaption">Caption</label>
          <input type="text" id="delayCaption" name="delayCaption" placeholder="Enter caption">
        </div>
        <div class="form-group">
          <label for="delayImageLink">Image Link</label>
          <input type="text" id="delayImageLink" name="delayImageLink" placeholder="Enter image URL">
        </div>
        <div class="form-group">
          <label for="delayHours">Delay (hours)</label>
          <input type="text" id="delayHours" name="delayHours" placeholder="e.g. 1.5" inputmode="decimal" pattern="\d+(\.\d)?" value="0">
          <div style="margin-top:8px; font-size:0.95rem; color:#cbd5e1; font-style:italic; color: #9b7bff;">Send will occur after the countdown below (page must remain open for it to complete).</div>
          <div id="delayCountdown" style="margin-top:8px; font-weight:700;"></div>
        </div>
      </div>
      <div id="multiFields" style="display: none;">
        <div class="form-group">
          <label>Links</label>
          <div id="multiList" style="display:flex;flex-direction:column;gap:10px;width:100%;box-sizing:border-box;"></div>
          <button type="button" id="addMultiBtn" class="add-multi-btn">+ Add link</button>
        </div>
      </div>
      <button type="submit" class="send-btn">Send</button>
      <div id="result" style="margin-top: 18px; font-size: 1.05rem;"></div>
    </form>
  </div>
</body>
<script>
  
  const modeText = document.getElementById('modeText');
  const modeImage = document.getElementById('modeImage');
  const modeDelay = document.getElementById('modeDelay');
  const modeMulti = document.getElementById('modeMulti');
  const labelText = document.getElementById('labelText');
  const labelImage = document.getElementById('labelImage');
  const labelDelay = document.getElementById('labelDelay');
  const labelMulti = document.getElementById('labelMulti');
  const textFields = document.getElementById('textFields');
  const imageFields = document.getElementById('imageFields');
  const delayFields = document.getElementById('delayFields');
  const delayHoursEl = document.getElementById('delayHours');
  const delayCaptionEl = document.getElementById('delayCaption');
  const multiFields = document.getElementById('multiFields');
  const multiList = document.getElementById('multiList');
  const addMultiBtn = document.getElementById('addMultiBtn');

  function updateMode() {
    if (modeText.checked) {
      textFields.style.display = '';
      imageFields.style.display = 'none';
      delayFields && (delayFields.style.display = 'none');
      multiFields.style.display = 'none';
      labelText.classList.add('active');
      labelImage.classList.remove('active');
      labelDelay && labelDelay.classList.remove('active');
      labelMulti.classList.remove('active');
    } else if (modeImage.checked) {
      textFields.style.display = 'none';
      imageFields.style.display = '';
      delayFields && (delayFields.style.display = 'none');
      multiFields.style.display = 'none';
      labelText.classList.remove('active');
      labelImage.classList.add('active');
      labelDelay && labelDelay.classList.remove('active');
      labelMulti.classList.remove('active');
    } else if (modeMulti.checked) {
      textFields.style.display = 'none';
      imageFields.style.display = 'none';
      delayFields && (delayFields.style.display = 'none');
      multiFields.style.display = '';
      labelText.classList.remove('active');
      labelImage.classList.remove('active');
      labelDelay && labelDelay.classList.remove('active');
      labelMulti.classList.add('active');
    } else if (modeDelay && modeDelay.checked) {
      // Delay mode shows the delayFields but hides others
      textFields.style.display = 'none';
      imageFields.style.display = 'none';
      delayFields && (delayFields.style.display = '');
      multiFields.style.display = 'none';
      labelText.classList.remove('active');
      labelImage.classList.remove('active');
      labelDelay && labelDelay.classList.add('active');
      labelMulti.classList.remove('active');
    }
  }
  modeText.addEventListener('change', updateMode);
  modeImage.addEventListener('change', updateMode);
  modeMulti.addEventListener('change', updateMode);
  if (modeDelay) modeDelay.addEventListener('change', updateMode);
  updateMode();


  // --- send button enable/disable logic ---
  const passcodeEl = document.getElementById('passcode');
  const messageEl = document.getElementById('message');
  const imageLinkEl = document.getElementById('imageLink');
  const captionEl = document.getElementById('caption');
  const delayImageLinkEl = document.getElementById('delayImageLink');
  const multiAddBtn = document.getElementById('addMultiBtn');
  const sendBtnEl = document.querySelector('.send-btn');

  function countValidMultiRows() {
    const rows = Array.from(multiList.children);
    const valid = rows.filter(row => {
      const inputs = row.querySelectorAll('input');
      return (inputs[0] && inputs[0].value.trim()) || (inputs[1] && inputs[1].value.trim());
    });
    return valid.length;
  }

  function updateSendButtonState() {
    if (!sendBtnEl) return;
    const hasPass = passcodeEl && passcodeEl.value.trim().length > 0;
    let enabled = false;

    if (modeText.checked) {
      enabled = hasPass && messageEl && messageEl.value.trim().length > 0;
    } else if (modeImage.checked) {
      // require at least an image link for image caption mode
      enabled = hasPass && imageLinkEl && imageLinkEl.value.trim().length > 0;
    } else if (modeDelay && modeDelay.checked) {
      // require at least an image link for delay mode and hours > 0
      const hoursVal = delayHoursEl ? parseFloat(delayHoursEl.value || '0') : 0;
      enabled = hasPass && delayImageLinkEl && delayImageLinkEl.value.trim().length > 0 && !isNaN(hoursVal) && hoursVal > 0;
    } else if (modeMulti.checked) {
      // multi requires at least two filled link rows (existing behavior)
      enabled = hasPass && countValidMultiRows() >= 2;
    }

    sendBtnEl.disabled = !enabled;
    if (!enabled) {
      sendBtnEl.style.opacity = '0.6';
      sendBtnEl.style.cursor = 'not-allowed';
    } else {
      sendBtnEl.style.opacity = '';
      sendBtnEl.style.cursor = '';
    }
  }

  // wire events to re-check state
  [passcodeEl, messageEl, imageLinkEl, captionEl, delayImageLinkEl, delayHoursEl, delayCaptionEl].forEach(el => {
    if (!el) return;
    el.addEventListener('input', updateSendButtonState);
  });

  // watch multi list for input changes and structural changes
  if (multiList) {
    multiList.addEventListener('input', updateSendButtonState);
    const mo = new MutationObserver(updateSendButtonState);
    mo.observe(multiList, { childList: true, subtree: true, characterData: true });
  }
  if (multiAddBtn) multiAddBtn.addEventListener('click', () => setTimeout(updateSendButtonState, 50));

  // run once at startup
  updateSendButtonState();

  // make the delay hours input accept decimals with up to one decimal place
  if (delayHoursEl) {
    delayHoursEl.addEventListener('input', (e) => {
      let v = e.target.value.replace(',', '.');
      // allow only digits and dot
      v = v.replace(/[^0-9.]/g, '');
      // collapse extra dots and limit to one decimal digit
      const parts = v.split('.');
      if (parts.length > 1) {
        // keep first part and first digit of the fractional part
        parts[1] = parts[1].slice(0, 1);
        v = parts[0] + '.' + parts[1];
      } else {
        v = parts[0];
      }
      if (v.startsWith('.')) v = '0' + v;
      e.target.value = v;
    });
    delayHoursEl.addEventListener('blur', (e) => {
      if (e.target.value === '') e.target.value = '0';
    });
  }

  const themeToggle = document.getElementById('themeToggle');
  const root = document.documentElement;
  function applyTheme(theme) {
    if (theme === 'light') {
      root.classList.add('light-theme');
      
  themeToggle.textContent = 'Dark';
    } else {
      root.classList.remove('light-theme');
      
  themeToggle.textContent = 'Light';
    }
    localStorage.setItem('randotron-theme', theme);
  }
  const savedTheme = localStorage.getItem('randotron-theme') || 'dark';
  applyTheme(savedTheme);
  themeToggle.addEventListener('click', () => {
    const current = root.classList.contains('light-theme') ? 'light' : 'dark';
    applyTheme(current === 'light' ? 'dark' : 'light');
  });

  
  function createMultiRow(caption = '', url = '', isProtected = false) {
    const wrapper = document.createElement('div');
  wrapper.style.display = 'flex';
  wrapper.style.gap = '8px';
  wrapper.style.alignItems = 'center';
  wrapper.style.flexWrap = 'wrap';
  wrapper.style.width = '100%';

    const cap = document.createElement('input');
    cap.type = 'text';
    cap.placeholder = 'Caption';
    cap.value = caption;
    cap.style.flex = '1';
    cap.style.padding = '10px';
  cap.style.minWidth = '0';
  cap.style.boxSizing = 'border-box';
  cap.style.borderRadius = '8px';
    

    const urlIn = document.createElement('input');
    urlIn.type = 'text';
    urlIn.placeholder = 'Link URL';
    urlIn.value = url;
    urlIn.style.flex = '1';
    urlIn.style.padding = '10px';
  urlIn.style.minWidth = '0';
  urlIn.style.boxSizing = 'border-box';
  urlIn.style.borderRadius = '8px';
    

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = 'âœ•';
    removeBtn.title = 'Remove';
  removeBtn.style.padding = '8px 10px';
    removeBtn.style.borderRadius = '8px';
    removeBtn.style.border = '1px solid #353945';
    removeBtn.style.background = '#2b2f39';
    removeBtn.style.color = '#fff';
  removeBtn.style.flex = '0 0 auto';

    removeBtn.disabled = true;
    removeBtn.setAttribute('aria-disabled', 'true');
    removeBtn.style.opacity = '0.45';
    removeBtn.style.cursor = 'not-allowed';

    function updateRemoveState() {
      // Allow removing a row if it's not protected and at least one of caption or URL is filled.
      const canRemove = !isProtected && (cap.value.trim().length > 0 || urlIn.value.trim().length > 0);
      removeBtn.disabled = !canRemove;
      removeBtn.setAttribute('aria-disabled', String(!canRemove));
      removeBtn.style.opacity = canRemove ? '1' : '0.45';
      removeBtn.style.cursor = canRemove ? 'pointer' : 'not-allowed';
    }

    cap.addEventListener('input', updateRemoveState);
    urlIn.addEventListener('input', updateRemoveState);

    removeBtn.addEventListener('click', (e) => {
      
      if (removeBtn.disabled) return;
      wrapper.remove();
    });
    
  if (isProtected) updateRemoveState();

    wrapper.appendChild(cap);
    wrapper.appendChild(urlIn);
    wrapper.appendChild(removeBtn);
    return wrapper;
  }

  addMultiBtn.addEventListener('click', () => {
    const resultDiv = document.getElementById('result');
    const lastRow = multiList.lastElementChild;
    if (lastRow) {
      const inputs = lastRow.querySelectorAll('input');
      const lastUrlFilled = inputs[1].value.trim().length > 0;
      if (!lastUrlFilled) {
        resultDiv.textContent = 'Please fill the previous URL before adding a new link.';
        return;
      }
    }
    resultDiv.textContent = '';
    multiList.appendChild(createMultiRow());
  });

  if (multiList.children.length === 0) {
    multiList.appendChild(createMultiRow('', '', true));
  multiList.appendChild(createMultiRow('', '', true));
  }

  async function postText(passcode, text) {
    const resp = await fetch('https://eac-151931141732.northamerica-northeast2.run.app', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ passcode: passcode, text: text })
    });
    if (!resp.ok) {
      const errorText = await resp.text();
      throw new Error(errorText || 'Request failed');
    }
    return resp.json().catch(() => ({}));
  }

  document.getElementById('randotronForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const passcode = document.getElementById('passcode').value;
    const resultDiv = document.getElementById('result');
    const form = document.getElementById('randotronForm');
    const sendBtn = form.querySelector('.send-btn');
    function resetFormFields() {
  const passcodeVal = document.getElementById('passcode').value;
  form.reset();
  document.getElementById('passcode').value = passcodeVal;

  multiList.innerHTML = '';
  multiList.appendChild(createMultiRow('', '', true));
  multiList.appendChild(createMultiRow('', '', true));
  updateMode();
  // restore send button to default state
  if (sendBtn) {
    sendBtn.classList.remove('scheduled-btn');
    sendBtn.textContent = 'Send';
  }
  // clear any pending interval
  if (window._randotronDelayInterval) {
    clearInterval(window._randotronDelayInterval);
    window._randotronDelayInterval = null;
  }
  // update send button state after reset
  try { updateSendButtonState(); } catch (e) {}
    }

    resultDiv.textContent = 'Sending...';

    try {
      if (modeText.checked) {
        const message = document.getElementById('message').value;
        const data = await postText(passcode, message);
        resultDiv.textContent = 'Success! ' + (data.message || 'Message sent.');
        resetFormFields();
        return;
      }

      if (modeImage.checked) {
        const caption = document.getElementById('caption').value;
        const imageLink = document.getElementById('imageLink').value;
        await postText(passcode, caption);
        const data2 = await postText(passcode, imageLink);
        resultDiv.textContent = 'Success! ' + (data2.message || 'Caption and image sent.');
        resetFormFields();
        return;
      }

      if (modeDelay && modeDelay.checked) {
        const caption = document.getElementById('delayCaption').value;
        const imageLink = document.getElementById('delayImageLink').value;
  const hours = parseFloat(document.getElementById('delayHours').value || '0');
        const resultCountdown = document.getElementById('delayCountdown');

        // validate > 0 and at most one decimal place
        if (isNaN(hours) || hours <= 0 || !/^-?\d+(\.\d)?$/.test(String(document.getElementById('delayHours').value || '0'))) {
          resultDiv.textContent = 'Please enter a number greater than 0 with at most one decimal place (e.g. 0.5 or 1).';
          return;
        }

        // Calculate target time (ms)
        const now = Date.now();
        const delayMs = Math.max(0, Math.round(hours * 60 * 60 * 1000));
        const target = now + delayMs;

        // Show initial message and start countdown that runs while page is open
        resultDiv.textContent = `Scheduled to send in ${hours} hour(s). Countdown will run while this page remains open.`;
        // change send button into scheduled state
        if (sendBtn) {
          sendBtn.classList.add('scheduled-btn');
          sendBtn.textContent = 'Scheduled Send';
        }

        // Clear any existing interval stored on window
        if (window._randotronDelayInterval) {
          clearInterval(window._randotronDelayInterval);
          window._randotronDelayInterval = null;
        }

        function updateCountdownDisplay() {
          const remaining = target - Date.now();
          if (remaining <= 0) {
            resultCountdown.textContent = 'Sending now...';
            clearInterval(window._randotronDelayInterval);
            window._randotronDelayInterval = null;
            // perform the sends: caption then imageLink
            (async () => {
              try {
                if (caption) await postText(passcode, caption);
                if (imageLink) await postText(passcode, imageLink);
                // clear the 'Sending now...' countdown message and show success
                if (resultCountdown) resultCountdown.textContent = '';
                resultDiv.textContent = 'Success! Delayed send completed.';
                resetFormFields();
              } catch (err) {
                resultDiv.textContent = 'Error during delayed send: ' + err.message;
                // restore send button if there was an error
                if (sendBtn) {
                  sendBtn.classList.remove('scheduled-btn');
                  sendBtn.textContent = 'Send';
                }
              }
            })();
            return;
          }
          // format remaining into h:mm:ss
          const sec = Math.floor(remaining / 1000);
          const hoursLeft = Math.floor(sec / 3600);
          const minsLeft = Math.floor((sec % 3600) / 60);
          const secsLeft = sec % 60;
          resultCountdown.textContent = `${hoursLeft}h ${String(minsLeft).padStart(2,'0')}m ${String(secsLeft).padStart(2,'0')}s`;
        }

        updateCountdownDisplay();
        // store interval so we can clear if user reschedules
        window._randotronDelayInterval = setInterval(updateCountdownDisplay, 1000);

        // Do not reset form fields now; they will be reset after successful send
        return;
      }

  if (modeMulti.checked) {
        
        const rows = Array.from(multiList.children).map(row => {
          const inputs = row.querySelectorAll('input');
          return { 
            caption: inputs[0].value.trim(), 
            url: inputs[1].value.trim(),
            element: row // keep reference to DOM element
          };
        }).filter(r => r.caption || r.url);

        if (rows.length < 2) {
          resultDiv.textContent = 'Please add at least two link.';
          return;
        }

        let failedAtIndex = -1;
        let failedOnCaption = false;
        for (let i = 0; i < rows.length; i++) {
          const r = rows[i];
          if (r.caption) {
            try {
              await postText(passcode, r.caption);
            } catch (err) {
              failedAtIndex = i;
              failedOnCaption = true;
              resultDiv.textContent = `Error sending caption for link ${i + 1}: ${err.message}`;
              break;
            }

            if (r.url) {
              try {
                await postText(passcode, r.url);
              } catch (err) {
                failedAtIndex = i;
                failedOnCaption = false;
                resultDiv.textContent = `Error sending URL for link ${i + 1} after caption succeeded: ${err.message}`;
                break;
              }
            }

          } else if (r.url) {
            try {
              await postText(passcode, r.url);
            } catch (err) {
              failedAtIndex = i;
              failedOnCaption = false;
              resultDiv.textContent = `Error sending URL for link ${i + 1}: ${err.message}`;
              break;
            }
          }
        }

        // If there was an error, remove successful entries and reposition remaining rows sequentially
        if (failedAtIndex !== -1) {
          // Get all rows from the failed one onwards
          const remainingRows = rows.slice(failedAtIndex);
          
          // Remove all rows before and including the failed one
          for (let i = 0; i <= failedAtIndex; i++) {
            if (rows[i] && rows[i].element) {
              rows[i].element.remove();
            }
          }

          // Add remaining rows back in sequence
          remainingRows.forEach((row, index) => {
            multiList.appendChild(row.element);
            // If this is the failed row and it failed on caption, clear only the caption
            if (index === 0 && failedOnCaption) {
              const inputs = row.element.querySelectorAll('input');
              if (inputs[0]) inputs[0].value = ''; // Clear only caption, leave URL
            }
          });
          return;
        }

        // If there was an error, remove successful entries and reposition remaining rows sequentially
        if (failedAtIndex !== -1) {
          // Get all rows from the failed one onwards
          const remainingRows = rows.slice(failedAtIndex);
          
          // Remove all rows before and including the failed one
          for (let i = 0; i <= failedAtIndex; i++) {
            if (rows[i] && rows[i].element) {
              rows[i].element.remove();
            }
          }

          // Add remaining rows back in sequence
          remainingRows.forEach((row, index) => {
            multiList.appendChild(row.element);
          });
          
          return;
        }

        resultDiv.textContent = 'Success! All links sent.';
        resetFormFields();
        return;
      }
    } catch (err) {
      resultDiv.textContent = 'Error: ' + err.message;
    }
  });
</script>
</html>
